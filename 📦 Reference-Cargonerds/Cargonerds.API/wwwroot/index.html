<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogisticsOS Live Feed</title>

    <!-- 1. Load Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- 3. Load Babel (to compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Load Framer Motion and Lucide -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. Load jsSHA for manual TOTP generation (Zero Dependency on otplib) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.js"></script>
</head>

<body class="bg-[#0c0a09] m-0 p-0 text-white">

    <div id="root"></div>

    <script type="text/babel">
        // --- ADAPTERS FOR CDN USAGE ---
        const { useState, useEffect, useRef } = React;
        const cn = (...classes) => classes.filter(Boolean).join(' ');
        const { useAnimationControls } = window.Motion;

        // --- NATIVE TOTP IMPLEMENTATION (No external library needed except jsSHA) ---
        const getTOTP = (secret) => {
            try {
                const dec2hex = (s) => (s < 15.5 ? '0' : '') + Math.round(s).toString(16);
                const hex2dec = (s) => parseInt(s, 16);

                const base32tohex = (base32) => {
                    const base32chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
                    let bits = "";
                    let hex = "";
                    for (let i = 0; i < base32.length; i++) {
                        let val = base32chars.indexOf(base32.charAt(i).toUpperCase());
                        bits += ("00000" + val.toString(2)).substr(-5);
                    }
                    for (let i = 0; i < bits.length - 3; i += 4) {
                        let chunk = bits.substr(i, 4);
                        hex = hex + parseInt(chunk, 2).toString(16);
                    }
                    return hex;
                };

                const epoch = Math.round(new Date().getTime() / 1000.0);
                const time = ("0000000000000000" + dec2hex(Math.floor(epoch / 30))).slice(-16);

                const shaObj = new jsSHA("SHA-1", "HEX");
                shaObj.setHMACKey(base32tohex(secret), "HEX");
                shaObj.update(time);
                const hmac = shaObj.getHMAC("HEX");

                const offset = hex2dec(hmac.substring(hmac.length - 1));
                let otp = (hex2dec(hmac.substr(offset * 2, 8)) & hex2dec('7fffffff')) + '';
                otp = (otp).substr(otp.length - 6, 6);
                return otp;
            } catch (e) {
                console.error("TOTP Gen Error", e);
                return "000000";
            }
        };

        const { motion, AnimatePresence } = window.Motion;

        // --- ICONS ---
        const Icon = ({ name, color, className }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return <i data-lucide={name} className={`w-4 h-4 ${color} ${className}`}></i>;
        };

        const Info = () => <Icon name="info" color="text-blue-400" />;
        const CheckCircle = () => <Icon name="check-circle" color="text-green-400" />;
        const AlertTriangle = ({ color }) => <Icon name="alert-triangle" color={color} />;
        const Activity = () => <Icon name="activity" />;
        const Plane = () => <Icon name="plane" />;
        const Calculator = () => <Icon name="calculator" />;
        const Home = () => <Icon name="home" />;

        // --- OTP COMPONENTS ---
        const CheckIcon = ({ size = 16, strokeWidth = 3, ...props }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth={strokeWidth}
                strokeLinecap="round"
                strokeLinejoin="round"
                {...props}
            >
                <path d="M20 6 9 17l-5-5" />
            </svg>
        );

        const OTPSuccess = () => {
            return (
                <div className="flex items-center justify-center gap-4 w-full">
                    <motion.div
                        initial={{ opacity: 0, scale: 0.5 }}
                        animate={{ opacity: 1, scale: 1 }}
                        transition={{ delay: 0.3, type: "spring", stiffness: 500, damping: 30 }}
                        className="w-16 h-16 bg-green-500 ring-4 ring-green-900 text-white flex items-center justify-center rounded-full"
                    >
                        <CheckIcon size={32} strokeWidth={3} />
                    </motion.div>
                    <motion.p
                        initial={{ opacity: 0, x: -10 }}
                        animate={{ opacity: 1, x: 0 }}
                        transition={{ delay: 0.4, duration: 0.4 }}
                        className="text-green-400 font-semibold text-lg"
                    >
                        Token Verified
                    </motion.p>
                </div>
            );
        };

        const OTPError = () => {
            return (
                <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -10 }}
                    transition={{ duration: 0.2 }}
                    className="text-center text-red-500 font-medium mt-2 absolute -bottom-8 w-full"
                >
                    Invalid Code. Try Again.
                </motion.div>
            );
        };

        const OTPInputBox = ({ index, verifyOTP, state }) => {
            const controls = useAnimationControls();
            const springTransition = { type: "spring", stiffness: 700, damping: 20, delay: index * 0.05 };
            const noDelaySpringTransition = { type: "spring", stiffness: 700, damping: 20 };
            const slowSuccessTransition = { type: "spring", stiffness: 300, damping: 30, delay: index * 0.06 };

            useEffect(() => {
                controls.start({ opacity: 1, y: 0, transition: springTransition });
            }, []);

            useEffect(() => {
                if (state === "success") {
                    const transitionX = index * 68;
                    controls.start({ x: -transitionX, transition: slowSuccessTransition });
                }
            }, [state]);

            const onFocus = () => controls.start({ y: -5, transition: noDelaySpringTransition });
            const onBlur = () => controls.start({ y: 0, transition: noDelaySpringTransition });

            const onKeyDown = (e) => {
                const { value } = e.target;
                if (e.key === "Backspace" && !value && index > 0) {
                    document.getElementById(`input-${index - 1}`)?.focus();
                } else if (e.key === "ArrowLeft" && index > 0) {
                    document.getElementById(`input-${index - 1}`)?.focus();
                } else if (e.key === "ArrowRight" && index < 3) {
                    document.getElementById(`input-${index + 1}`)?.focus();
                }
            };

            const onInput = (e) => {
                const { value } = e.target;
                if (value.match(/^[0-9]$/)) {
                    e.target.value = value;
                    if (index < 3) document.getElementById(`input-${index + 1}`)?.focus();
                } else {
                    e.target.value = "";
                }
                verifyOTP();
            };


            const onPaste = (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData("text").trim().slice(0, 4);
                const digits = pastedData.split("").filter((char) => /^[0-9]$/.test(char));
                digits.forEach((digit, i) => {
                    const targetIndex = index + i;
                    if (targetIndex < 4) {
                        const input = document.getElementById(`input-${targetIndex}`);
                        if (input) input.value = digit;
                    }
                });
                const nextFocusIndex = Math.min(index + digits.length, 3);
                document.getElementById(`input-${nextFocusIndex}`)?.focus();
                setTimeout(verifyOTP, 0);
            };

            return (
                <motion.div
                    className={`w-14 h-16 rounded-lg ring-2 ring-transparent overflow-hidden transition-all duration-300 ${state === "error" ? "ring-red-500" : state === "success" ? "ring-green-500" : "focus-within:ring-slate-500 ring-slate-800 bg-black"}`}
                    initial={{ opacity: 0, y: 10 }}
                    animate={controls}
                >
                    <input
                        id={`input-${index}`}
                        type="text"
                        inputMode="numeric"
                        maxLength={1}
                        onInput={onInput}
                        onKeyDown={onKeyDown}
                        onPaste={onPaste}
                        onFocus={onFocus}
                        onBlur={onBlur}
                        className="w-full h-full text-center text-3xl font-semibold outline-none bg-transparent text-white"
                        disabled={state === "success"}
                    />
                </motion.div>
            );
        };

        const OTPVerification = ({ onVerified }) => {
            const [mode, setMode] = useState("VERIFY"); // 'VERIFY' or 'SETUP'
            const [state, setState] = useState("idle");
            const [countdown, setCountdown] = useState(60);
            const [isResendDisabled, setIsResendDisabled] = useState(true);
            const controls = useAnimationControls();

            // YOUR PRIVATE SECRET KEY
            const SECRET = "KVKFKRCPNZQUYMLX";
            const otpUrl = `otpauth://totp/LogisticsOS:Admin?secret=${SECRET}&issuer=LogisticsOS`;
            const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(otpUrl)}`;

            useEffect(() => {
                let timer;
                if (isResendDisabled) {
                    timer = setInterval(() => {
                        setCountdown((prev) => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                setIsResendDisabled(false);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [isResendDisabled]);

            const getCode = () => {
                let code = "";
                for (let i = 0; i < 6; i++) { // Changed from 4 to 6
                    const input = document.getElementById(`input-${i}`);
                    if (input) code += input.value;
                }
                return code;
            };

            const verifyOTP = async () => {
                const code = getCode();
                if (code.length < 6) return;

                // Real TOTP Verification (Native via jsSHA)
                try {
                    // Calculate expected code using our native function
                    // We can check strict equality first. 
                    // To support drift, we could calculate (epoch-30) and (epoch+30) but let's try strict first.
                    // The phone and PC dates should be relatively close.

                    const expectedCode = getTOTP(SECRET);

                    console.log("[DEBUG] Validate:", { input: code, expected: expectedCode, secret: SECRET });

                    if (code === expectedCode) {
                        setState("success");
                        setTimeout(onVerified, 2000);
                    } else {
                        console.warn("Invalid Code. Expected:", expectedCode);
                        errorAnimation();
                    }
                } catch (e) {
                    console.error("Verification Error:", e);
                    errorAnimation();
                }
            };

            const errorAnimation = async () => {
                setState("error");
                await controls.start({ x: [0, 5, -5, 5, -5, 0], transition: { duration: 0.3 } });
                setTimeout(() => { if (getCode().length < 6) setState("idle"); }, 500); // Changed from 4 to 6
            };

            const handleResend = () => {
                setCountdown(60);
                setIsResendDisabled(true);
            };

            return (
                <div className="flex h-screen w-full bg-[#0c0a09] items-center justify-center font-sans">
                    <div
                        className="rounded-3xl p-8 w-full max-w-lg shadow-2xl relative overflow-hidden border border-slate-800"
                        style={{
                            backgroundImage: "url(https://media.giphy.com/media/3owypkjxtrXUvhJiCY/giphy.gif)",
                            backgroundSize: "cover",
                            backgroundPosition: "center",
                            backgroundRepeat: "no-repeat",
                        }}
                    >
                        <div className="absolute inset-0 bg-[#0c0a09]/95 rounded-3xl"></div>

                        <div className="relative z-10 text-white">
                            {/* Logo */}
                            <div className="flex justify-center mb-6">
                                <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg">
                                    <div className="flex space-x-1">
                                        <div className="w-2 h-2 bg-red-500 rounded-full"></div>
                                        <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                                    </div>
                                </div>
                            </div>

                            <h1 className="text-2xl font-semibold text-center mb-2">
                                {mode === 'SETUP' ? "Device Setup" : (state === "success" ? "Access Granted" : "Security Check")}
                            </h1>

                            <AnimatePresence mode="wait">
                                {mode === 'SETUP' ? (
                                    <motion.div key="setup" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }}>
                                        <div className="flex flex-col items-center">
                                            <p className="text-center text-slate-300 mb-4 text-sm">
                                                Scan this QR Code with <b>Google Authenticator</b> app on your phone.
                                            </p>
                                            <div className="p-4 bg-white rounded-xl mb-4 flex justify-center">
                                                <img src={qrImageUrl} alt="Scan this QR code" className="w-[180px] h-[180px]" />
                                            </div>
                                            <div className="text-center mb-4">
                                                <div className="text-xs text-slate-500 font-mono mb-1">SECRET KEY</div>
                                                <div className="font-mono text-blue-400 font-bold tracking-widest">{SECRET}</div>
                                            </div>
                                            <button
                                                onClick={() => setMode("VERIFY")}
                                                className="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-full font-bold transition-all text-sm"
                                            >
                                                I have scanned it â†’
                                            </button>
                                        </div>
                                    </motion.div>
                                ) : (
                                    state === "success" ? (
                                        <motion.div key="success" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="flex items-center justify-center h-[232px]">
                                            <OTPSuccess />
                                        </motion.div>
                                    ) : (
                                        <motion.div key="form" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                                            <p className="text-center text-slate-300 mt-2 mb-8 text-sm">
                                                Enter the 6-digit code from your <br /> <span className="font-bold text-white">Google Authenticator</span>
                                            </p>

                                            <div className="flex flex-col items-center justify-center gap-2 mb-8 relative h-20">
                                                <motion.div animate={controls} className="flex items-center justify-center gap-2">
                                                    {[0, 1, 2, 3, 4, 5].map((i) => (
                                                        <OTPInputBox key={i} index={i} verifyOTP={verifyOTP} state={state} />
                                                    ))}
                                                </motion.div>
                                                <AnimatePresence>{state === "error" && <OTPError />}</AnimatePresence>
                                            </div>

                                            <div className="flex justify-between items-center px-4 w-full">
                                                <button onClick={() => setMode("SETUP")} className="text-xs text-slate-500 hover:text-white transition-colors">
                                                    Configure New Device
                                                </button>
                                                {isResendDisabled ? (
                                                    <span className="text-slate-600 text-xs text-right">Refresh in {countdown}s</span>
                                                ) : (
                                                    <button onClick={handleResend} className="text-blue-400 font-medium hover:underline text-xs text-right">
                                                        Refresh
                                                    </button>
                                                )}
                                            </div>
                                        </motion.div>
                                    )
                                )}
                            </AnimatePresence>
                        </div>
                    </div>
                </div>
            );
        };

        // 1. LIVE FEED VIEW (The Terminal)
        const LiveFeedView = () => {
            const [logs, setLogs] = useState([]);
            const logContainerRef = useRef(null);

            const logTypes = {
                'INFO': { icon: <Info />, color: 'text-blue-400' },
                'SUCCESS': { icon: <CheckCircle />, color: 'text-green-400' },
                'WARNING': { icon: <AlertTriangle color="text-yellow-400" />, color: 'text-yellow-400' },
                'ERROR': { icon: <AlertTriangle color="text-red-400" />, color: 'text-red-400' }
            };

            const fetchLogs = async () => {
                try {
                    const response = await fetch('/api/emissions/history');
                    if (!response.ok) throw new Error("Failed to fetch");
                    const data = await response.json();

                    const newLogs = data.map(record => {
                        const type = record.co2Emission > 500 ? 'WARNING' : 'SUCCESS';
                        const config = logTypes[type];
                        let msgDetails = "";
                        if (type === 'WARNING') {
                            msgDetails = `[SYSTEM_ALERT] High Carbon Output detected. Shipment #${record.id} exceeds threshold. Output: ${record.co2Emission.toFixed(2)}kg CO2 | Dist: ${record.distanceKm}km | Payload: ${record.weightKg}kg | Status: FLAG_REVIEW`;
                        } else {
                            msgDetails = `process_shipment[${record.id}]: calculation_complete status=200 OK latency=45ms payload=${record.weightKg}kg distance=${record.distanceKm}km emission=${record.co2Emission.toFixed(2)}kg_co2 integrity=verified`;
                        }

                        return {
                            id: record.id,
                            timestamp: new Date(record.createdAt).toLocaleTimeString(),
                            type: type,
                            icon: config.icon,
                            color: config.color,
                            message: msgDetails
                        };
                    });
                    setLogs(newLogs);
                } catch (err) { console.error(err); }
            };

            // Simulation State
            const simulationRef = useRef(null);
            const [isSimulating, setIsSimulating] = useState(false);

            const startSimulation = () => {
                if (simulationRef.current) return; // Already running

                setIsSimulating(true);
                simulationRef.current = setInterval(async () => {
                    // Generate random shipment
                    const dist = Math.floor(Math.random() * 5000) + 100; // 100-5100 km
                    const weight = Math.floor(Math.random() * 2000) + 50; // 50-2050 kg

                    try {
                        await fetch('/api/emissions/calculate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ distanceKm: dist, weightKg: weight })
                        });
                        // We don't need to do anything with the result, 
                        // because the Live Feed poller will pick it up automatically!
                    } catch (e) {
                        console.error("Sim error", e);
                    }
                }, 3000); // New shipment every 3 seconds
            };

            const stopSimulation = () => {
                if (simulationRef.current) {
                    clearInterval(simulationRef.current);
                    simulationRef.current = null;
                }
                setIsSimulating(false);
            };

            const handleCommand = (e) => {
                if (e.key === 'Enter') {
                    const cmd = e.target.value.trim().toLowerCase();
                    e.target.value = '';

                    // Add command to log
                    const cmdLog = {
                        id: Date.now(),
                        timestamp: new Date().toLocaleTimeString(),
                        type: 'CLI',
                        icon: <Activity />,
                        color: 'text-white',
                        message: `admin@logistics-os:~$ ${cmd}`
                    };
                    setLogs(prev => [cmdLog, ...prev]);

                    // Process Command
                    setTimeout(() => {
                        let responseMsg = "";
                        let type = "INFO";

                        switch (cmd) {
                            case 'help':
                                responseMsg = "Available commands: status, clear, reboot, ping, sim start, sim stop";
                                break;
                            case 'status':
                                responseMsg = `System Operational. Uptime: 99.9%. Active Nodes: 42. [SIMULATION: ${isSimulating ? 'ONLINE' : 'OFFLINE'}]`;
                                type = "SUCCESS";
                                break;
                            case 'clear':
                                setLogs([]);
                                return;
                            case 'reboot':
                                window.location.reload();
                                return;
                            case 'ping':
                                responseMsg = "Pong! Latency: 12ms.";
                                break;
                            case 'sim start':
                                startSimulation();
                                responseMsg = "Background Traffic Generator [INITIATED]. Injecting random payloads...";
                                type = "SUCCESS";
                                break;
                            case 'sim stop':
                                stopSimulation();
                                responseMsg = "Background Traffic Generator [HALTED].";
                                type = "WARNING";
                                break;
                            default:
                                responseMsg = `Command not found: ${cmd}`;
                                type = "ERROR";
                        }

                        const resLog = {
                            id: Date.now() + 1,
                            timestamp: new Date().toLocaleTimeString(),
                            type: type,
                            icon: type === 'ERROR' ? <AlertTriangle color="text-red-400" /> : <CheckCircle />,
                            color: type === 'ERROR' ? 'text-red-400' : 'text-green-400',
                            message: responseMsg
                        };
                        setLogs(prev => [resLog, ...prev]);
                    }, 300);
                }
            };

            useEffect(() => {
                fetchLogs();
                const interval = setInterval(fetchLogs, 2000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="w-full h-full flex flex-col pt-10 px-10">
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold mb-2">Network Activity</h1>
                        <p className="text-slate-400">Real-time log stream from the Primary DB</p>
                    </div>
                    <div className="w-full max-w-5xl mx-auto h-[600px] bg-black/80 rounded-lg border border-slate-800 shadow-2xl flex flex-col relative overflow-hidden">
                        <div className="h-10 bg-slate-900 border-b border-slate-800 flex items-center px-4 justify-between z-20 relative">
                            <div className="flex gap-2"><div className="w-3 h-3 rounded-full bg-red-500"></div><div className="w-3 h-3 rounded-full bg-yellow-500"></div><div className="w-3 h-3 rounded-full bg-green-500"></div></div>
                            <span className="text-xs text-slate-500 font-mono">/var/log/syslog</span>
                            <div className="w-4"></div>
                        </div>

                        {/* Log Output Area */}
                        <div className="flex-1 overflow-auto p-4 font-mono text-sm text-slate-300 relative z-10 no-scrollbar mb-10">
                            <AnimatePresence initial={false}>
                                {logs.map(log => (
                                    <motion.div key={log.id} layout initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} className="flex gap-4 mb-2">
                                        <span className="text-slate-600 w-24 shrink-0">{log.timestamp}</span>
                                        <div className={cn("flex items-center gap-2 font-bold w-24 shrink-0", log.color)}>
                                            {log.icon} <span>[{log.type}]</span>
                                        </div>
                                        <span className="truncate">{log.message}</span>
                                    </motion.div>
                                ))}
                            </AnimatePresence>
                        </div>

                        {/* Interactive CLI Input */}
                        <div className="h-12 border-t border-slate-800 bg-black flex items-center px-4 z-20">
                            <span className="text-green-500 font-mono mr-2">admin@logistics-os:~$</span>
                            <input
                                type="text"
                                autoFocus
                                className="bg-transparent border-none outline-none text-white font-mono w-full"
                                placeholder="Type command..."
                                onKeyDown={handleCommand}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        // 2. CO2 CALCULATOR VIEW
        const Co2View = () => {
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);

            const handleSimulate = async (e) => {
                e.preventDefault();
                setLoading(true);
                const d = e.target.dist.value;
                const w = e.target.weight.value;

                try {
                    const res = await fetch('/api/emissions/calculate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ distanceKm: Number(d), weightKg: Number(w) })
                    });
                    const data = await res.json();
                    setResult(data);
                } catch (err) { alert("Error"); }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center h-full flex-col">
                    <div className="max-w-md w-full bg-slate-900/50 p-8 rounded-2xl border border-slate-800">
                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Icon name="calculator" /> Emission Calculator</h2>
                        <form onSubmit={handleSimulate} className="space-y-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Distance (km)</label>
                                <input name="dist" type="number" className="w-full bg-black border border-slate-700 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500" required />
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Weight (kg)</label>
                                <input name="weight" type="number" className="w-full bg-black border border-slate-700 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500" required />
                            </div>
                            <button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold transition-all disabled:opacity-50">
                                {loading ? 'Computing...' : 'Calculate Impact'}
                            </button>
                        </form>

                        {result && (
                            <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="mt-8 text-center p-4 bg-slate-800/50 rounded-lg">
                                <div className="text-4xl font-bold text-white mb-1">{result.emission.toFixed(2)}</div>
                                <div className="text-sm text-slate-400">kg CO2 Equivalent</div>
                                <div className="mt-2 text-blue-400 font-mono text-xs">DB Record #{result.id}</div>
                            </motion.div>
                        )}
                    </div>
                </div>
            );
        };

        // 3. FLIGHT TRACKER VIEW
        const FlightView = () => {
            return (
                <div className="w-full h-full flex flex-col items-center justify-center text-center p-10">
                    <div className="w-64 h-64 bg-slate-900 rounded-full flex items-center justify-center mb-6 relative border border-slate-800">
                        <div className="absolute inset-0 rounded-full border border-blue-500/30 animate-ping"></div>
                        <Icon name="plane" className="w-24 h-24 text-blue-500" />
                    </div>
                    <h2 className="text-3xl font-bold">Global Flight Tracking</h2>
                    <p className="text-slate-400 mt-2 max-w-lg">
                        This module connects to external transponders to visualize real-time cargo movements.
                        <br />
                        <span className="text-yellow-500 text-sm mt-4 inline-block font-mono">STATUS: MOCK DATA MODE</span>
                    </p>
                </div>
            );
        };

        // --- SHELL ---
        const App = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [path, setPath] = useState(window.location.pathname);

            useEffect(() => {
                const handlePopState = () => setPath(window.location.pathname);
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, []);

            const navigate = (to) => {
                window.history.pushState({}, '', to);
                setPath(to);
            };

            const NavLink = ({ to, label }) => (
                <button
                    onClick={() => navigate(to)}
                    className={`px-3 py-1 rounded text-sm font-medium transition-colors ${path === to ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                >
                    {label}
                </button>
            );

            if (!isAuthenticated) {
                return <OTPVerification onVerified={() => setIsAuthenticated(true)} />;
            }

            return (
                <div className="flex flex-col h-screen w-full bg-[#0c0a09] text-white overflow-hidden font-sans">
                    {/* Minimal Header - Removed per request */}

                    {/* Main Content Area */}
                    <div className="flex-1 relative overflow-auto">
                        <div className="absolute inset-0 z-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>

                        <div className="relative z-10 w-full min-h-full">
                            {path === '/' && <LiveFeedView />}
                            {path === '/co2' && <Co2View />}
                            {path === '/flight' && <FlightView />}

                            {!['/', '/co2', '/flight'].includes(path) && (
                                <div className="h-full flex items-center justify-center flex-col text-slate-500">
                                    <h1 className="text-4xl font-bold text-white mb-2">404</h1>
                                    <p>Page not found for path: {path}</p>
                                    <button onClick={() => navigate('/')} className="mt-4 text-blue-400 hover:underline">Return Home</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>